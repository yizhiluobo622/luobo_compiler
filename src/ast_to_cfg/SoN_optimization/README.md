# SoN优化Pass职责分工

## 🎯 **优化Pass架构**

为了避免重复优化和提高效率，各个优化Pass有明确的职责分工：

### **Round 0: 类型推断**
- **Pass**: `TypeInferencePass`
- **职责**: 建立类型约束和类型注解
- **时机**: 在所有优化之前运行，为后续优化提供类型信息

### **Round 1: 基础优化**
- **Pass**: `ConstantPropagation`
- **职责**: 专注于常量传播和常量折叠
- **功能**: 
  - 识别变量到常量的映射
  - 传播常量值到使用点
  - 常量折叠优化
  - 理想化优化（代数恒等式）
  - **不处理**: CSE、GVN、GCM等通用优化

- **Pass**: `CombinedOptimizer` (GVN + GCM + CSE)
- **职责**: 统一处理所有通用优化
- **功能**:
  - **CSE**: 公共子表达式消除
  - **GVN**: 全局值编号
  - **GCM**: 全局代码移动
  - **不处理**: 常量传播和常量折叠

- **Pass**: `NodeDCE` + `GlobalDCE`
- **职责**: 死代码消除
- **功能**: 删除无用的节点和代码

### **Round 2: 高级优化**
- **Pass**: `PeepholeOptimizer`
- **职责**: 窥孔优化
- **功能**: 局部模式匹配和重写

## 🔄 **优化流程**

```
AST → SoNir → 类型推断 → 常量传播 → 通用优化 → 死代码消除 → 窥孔优化
```

## ✅ **避免重复的机制**

1. **职责分离**: 每个Pass只处理特定类型的优化
2. **顺序执行**: 优化Pass按合理顺序执行，避免冲突
3. **类型信息共享**: 类型推断Pass为所有后续优化提供类型信息
4. **统计信息**: 每个Pass都有独立的统计信息，便于监控

## 📊 **优化效果**

- **常量传播**: 减少运行时计算，提高性能
- **CSE**: 消除重复计算，减少代码大小
- **GVN**: 识别等价表达式，支持更多优化
- **GCM**: 优化代码布局，提高缓存效率
- **死代码消除**: 减少代码大小，提高可读性

## 🚀 **扩展建议**

- 可以添加更多专门的优化Pass
- 支持优化Pass的配置和开关
- 添加优化Pass之间的依赖关系检查
- 实现优化Pass的并行执行（如果安全的话）
